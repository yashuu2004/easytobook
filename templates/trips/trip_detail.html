{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="card trip-detail-card">
  <div class="card-body">

    <h2 class="card-title">
      {{ trip.get_transport_type_display }}:
      {{ trip.source_city.name }} ‚Üí {{ trip.destination_city.name }}
    </h2>

    <p class="card-desc mt-1">
      <strong>Date:</strong> {{ trip.date }} |
      <strong>Time:</strong> {{ trip.time }} <br>
      <strong>Available seats:</strong> {{ trip.available_seats }} |
      <strong>Price:</strong> ‚Çπ{{ trip.price }}
    </p>

    <!-- ‚≠ê Seat legend -->
    <div style="margin-bottom:15px;">
      <span style="margin-right:20px;">üü© Available</span>
      <span style="margin-right:20px;">üü™ Selected</span>
      <span>üü• Booked</span>
    </div>

    <form method="post"
          action="{% url 'bookings:create' trip.id %}"
          class="seat-form">
      {% csrf_token %}

      <h4>Select Seats</h4>

      <div class="bus-layout">

        {% for row in "ABCDE" %}
        <div class="seat-row">

          {% for num in "12" %}
          {% with seat=row|add:num %}
          <label class="seat {% if seat in booked_seats %}booked{% endif %}">
            <input type="checkbox"
                   name="seats_selected"
                   value="{{ seat }}"
                   {% if seat in booked_seats %}disabled{% endif %}>
            <span>{{ seat }}</span>
          </label>
          {% endwith %}
          {% endfor %}

          <div class="aisle"></div>

          {% for num in "34" %}
          {% with seat=row|add:num %}
          <label class="seat {% if seat in booked_seats %}booked{% endif %}">
            <input type="checkbox"
                   name="seats_selected"
                   value="{{ seat }}"
                   {% if seat in booked_seats %}disabled{% endif %}>
            <span>{{ seat }}</span>
          </label>
          {% endwith %}
          {% endfor %}

        </div>
        {% endfor %}

      </div>

      <!-- ‚≠ê Live counter -->
      <p id="seatCount" class="mt-2">Seats selected: 0</p>
      <p id="totalPrice">Total: ‚Çπ0</p>
     
   <h4>Passenger Details</h4>
   <div id="passengerForms"></div>
      <button type="submit" class="btn btn-primary mt-2">
        Proceed to Payment
      </button>
<hr>



    </form>

  </div>
</div>

<a href="{% url 'trips:search' %}" class="btn btn-secondary mt-2">
  ‚Üê Back to Search
</a>

<!-- ‚≠ê Live seat JS -->
<script>
const price = {{ trip.price }};
const checkboxes = document.querySelectorAll('input[name="seats_selected"]');
const countEl = document.getElementById('seatCount');
const totalEl = document.getElementById('totalPrice');
const passengerDiv = document.getElementById('passengerForms');

function updatePassengers() {
  passengerDiv.innerHTML = "";

  const selectedSeats = document.querySelectorAll('input[name="seats_selected"]:checked');

  selectedSeats.forEach(seat => {
    const seatName = seat.value;

    const div = document.createElement("div");
    div.style.marginBottom = "10px";

    div.innerHTML = `
      <label>${seatName} Passenger Name:</label>
      <input type="text" name="passenger_${seatName}" required class="form-input">
    `;

    passengerDiv.appendChild(div);
  });
}

checkboxes.forEach(cb => {
  cb.addEventListener('change', () => {
    const selected = document.querySelectorAll('input[name="seats_selected"]:checked').length;
    countEl.textContent = "Seats selected: " + selected;
    totalEl.textContent = "Total: ‚Çπ" + (selected * price);
    updatePassengers();
  });
});
</script>


{% endblock %}
